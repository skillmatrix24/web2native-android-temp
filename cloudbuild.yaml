substitutions:
  _USER_ID: "local"
  _APP_ID: "local"
  _APP_NAME: "Web2Native App"
  _PACKAGE_NAME: "com.web2native.app"

steps:
  # 1ï¸âƒ£ Clone Android template repo
  - name: gcr.io/cloud-builders/git
    args:
      - clone
      - https://github.com/skillmatrix24/web2native-android-temp.git

  # 2ï¸âƒ£ Build SIGNED APK + AAB
  - name: ghcr.io/cirruslabs/android-sdk:36
    dir: web2native-android-temp
    entrypoint: bash
    secretEnv:
      - KEYSTORE_BASE64
      - KEYSTORE_PASSWORD
      - KEY_ALIAS
      - KEY_PASSWORD
    args:
      - -c
      - |
        set -e
        chmod +x ./gradlew

        echo "ðŸ‘¤ USER_ID=${_USER_ID}"
        echo "ðŸ“¦ APP_ID=${_APP_ID}"
        echo "ðŸ“± APP_NAME=${_APP_NAME}"
        echo "ðŸ“› PACKAGE=${_PACKAGE_NAME}"

        echo "ðŸ“‚ Writing keystore (CI runtime)"
        mkdir -p keystore
        printf "%s" "$$KEYSTORE_BASE64" | base64 -d > keystore/web2native-release.jks

        echo "ðŸš€ Building RELEASE APK"
        ./gradlew clean assembleRelease

        echo "ðŸš€ Building RELEASE AAB"
        ./gradlew bundleRelease

availableSecrets:
  secretManager:
    - versionName: projects/studio-7777713866-cb01e/secrets/KEYSTORE_BASE64/versions/latest
      env: KEYSTORE_BASE64
    - versionName: projects/studio-7777713866-cb01e/secrets/KEYSTORE_PASSWORD/versions/latest
      env: KEYSTORE_PASSWORD
    - versionName: projects/studio-7777713866-cb01e/secrets/KEY_ALIAS/versions/latest
      env: KEY_ALIAS
    - versionName: projects/studio-7777713866-cb01e/secrets/KEY_PASSWORD/versions/latest
      env: KEY_PASSWORD

artifacts:
  objects:
    location: gs://studio-7777713866-cb01e.firebasestorage.app/apks/${_USER_ID}/${_APP_ID}/
    paths:
      - web2native-android-temp/app/build/outputs/apk/release/app-release.apk
      - web2native-android-temp/app/build/outputs/bundle/release/app-release.aab

options:
  logging: CLOUD_LOGGING_ONLY

timeout: 1800s
